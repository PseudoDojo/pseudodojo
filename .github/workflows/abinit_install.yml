name: Install ABINIT
run-name: ${{ github.actor }} is installing libxc and abinit

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache LibXC
      uses: actions/cache@v3
      with:
        path: |
          $HOME/libxc
        key: libxc-4.3.4-${{ runner.os }}-${{ hashFiles('**/libxc-4.3.4.tar.gz') }}
        restore-keys: |
          libxc-4.3.4-${{ runner.os }}-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf libtool pkg-config liblapack-dev libblas-dev libfftw3-dev libnetcdf-dev libnetcdff-dev

    - name: Download and Compile LibXC
      run: |
        if [ ! -d "$HOME/libxc" ]; then
          wget http://www.tddft.org/programs/libxc/down.php?file=4.3.4/libxc-4.3.4.tar.gz -O libxc-4.3.4.tar.gz
          tar -xvf libxc-4.3.4.tar.gz
          cd libxc-4.3.4
          ./configure --prefix=$HOME/libxc
          make
          make install
        fi
        echo "Listing contents of /home/runner/libxc:"
        ls /home/runner/libxc
        echo "Listing contents of /home/runner/libxc/lib:"
        ls /home/runner/libxc/lib
        cd ..

    - name: Set environment variables for LibXC
      run: |
        echo "Below steps don't seem to be working..."
        echo "LIBXC_DIR=$HOME/libxc" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=$HOME/libxc/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

    - name: Download and compile ABINIT
      run: |
        git clone https://github.com/abinit/abinit.git
        cd abinit
        ./autogen.sh
        ./configure --with-libxc=/home/runner/libxc/lib/
        make
        sudo make install

    - name: Copy config.log on failure
      if: failure()
      run: |
        cp abinit/config.log ${{ github.workspace }}